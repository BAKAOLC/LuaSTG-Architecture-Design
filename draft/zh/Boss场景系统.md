# 设计草案：Boss场景系统

[English Version](../en/Boss%20Scene%20System.md)

## 背景

在当前的游戏开发框架中，我们使用了一个全局的 boss 类作为游戏中 boss 的逻辑对象，并拆分了 boss_system/boss_ui 等模块来处理 boss 的逻辑和 UI 显示。
但是由于拆分和修改时为了保留远古代码的兼容性，导致功能实际并不完善，且存在许多奇怪的特性。

这导致了许多问题，例如：

- 需要 boss 在最后能发起对话时，我们必须在最后额外增加一个通常攻击阶段，或者直接通过 flag 禁用掉 boss 的爆炸特效。
- boss 爆炸特效执行完毕后会主动的删除自身，导致不方便实现爆炸后的对话。
- ui 逻辑和 boss 逻辑存在耦合，导致难以作为部件复用。
- boss 的逻辑对多个 boss 的支持并不友好，需要大量额外的逻辑来处理多个 boss 的情况。
- 符卡练习、需要根据不同角色或逻辑执行不同战斗阶段等需求，需要大量额外的逻辑来处理。

## 提案

我们提议使用一个新的 boss 场景系统来作为替代方案，以解决上述问题。

这个 boss 场景系统大致包含以下几个部分：

#### 数据结构

1. `Boss Battle Stage`：负责定义一个 boss 的战斗阶段，包含 boss 的行为、是否开启分数计算、是否开启符卡宣言等逻辑。
2. `Boss Style`：负责定义一个 boss 的样式，包含 boss 的外观、动画、音效等信息，本身不包含逻辑，可以随意替换并且不影响正常流程的进行。
3. `Boss Scene`：负责定义一个 boss 场景，包含场景内各种 boss 需要怎么出现、调用哪些战斗阶段、怎么切换等逻辑。

#### 实体对象

1. `Boss Entity`：`Boss Style`的实例化对象，负责渲染 boss 的外观、接受攻击判定、接受各种事件执行相应的动画、音效等逻辑。
2. `Boss Scene Controller`：负责控制整个 boss 场景的逻辑，作为单例存在，用于控制 boss 的生成、销毁、切换等各种逻辑。

#### 额外组件

1. `血条`、`信息名牌`等 Boss 信息组件： 独立的渲染信息部件，具有一定的预定义样式，通过主动调用更新方法来传递数据变更显示的数据信息。
2. `Dialog System` + `Dialog Character` + `Dialog Balloon` / `Dialog Box`: 独立的对话系统，用于创建和管理对话组件，通过添加角色和气泡或对话框来进行对话等表现

## 详细说明

#### Boss Battle Stage

该结构类似于当前的 spellcard / dialog / move 等阶段的定义，但是有以下区别：

1. 在外层单独定义，通过某种 id 或其它索引机制来获取该结构的定义。
2. 不和任何对象进行绑定，可用的 boss 对象来自于传入的参数，只需要根据数字索引来分别控制不同的 boss，因此只要传入的 boss 数量正确，无论 boss 替换成什么样式，都不会也不应该会影响到逻辑的执行。
3. 可以定义 boss 的行为、是否开启分数计算、是否开启符卡宣言等逻辑，以及其他各种和战斗阶段相关的逻辑。
4. 可以定义血量和时间等应该以何种方式处理，如是否血量同步、是否需要都击破还是只需要击破其中一个等。

#### Boss Style / Boss Entity

该结构类似于当前的 boss 类，但是有以下区别：

1. 不包含逻辑，只包含外观、动画、音效等信息。
2. 只有一个事件接口，用于接受事件并执行相应的动画、音效等逻辑，并且将受击判定等数据发送给 `Boss Scene Controller` 进行处理。
3. 可以随意替换，不影响正常流程的进行。

#### Boss Scene

该结构类似于当前的 boss 定义的战斗阶段列表，但是有以下区别：

1. 它可以执行部分逻辑，如创建 boss、销毁 boss、切换战斗阶段等。
2. 它需要在逻辑中进行判断，指定发起某个战斗阶段，并传入这个战斗阶段需要的 boss 对象（同时需要保证未使用到的 boss 对象正确的离场）。
3. 它发起战斗阶段后会进入等待状态，直到战斗阶段结束才会继续执行逻辑。

#### Boss Scene Controller

该结构类似于当前的 boss_system，但是有以下区别：

1. 作为单例存在，负责控制整个 boss 场景的逻辑。
2. 所有 boss 对象的伤害计算、时间计算、判断是否结束等逻辑都在这里进行。
3. 提供大量的 api 接口，用于访问控制 boss 的生成、销毁、切换等各种逻辑、获取当前的分数、获取当前的符卡等信息、ui 的更新等。
4. 可以通过事件机制来进行和外部的交互，如 boss 的受击判定、boss 的事件、boss 的状态等。

## 优势

1. 逻辑和外观分离，可以随意替换 boss 的外观而不影响逻辑的执行。
2. 方便实现多个 boss 的支持，只需要传入正确的 boss 对象即可。
3. 需要根据不同角色或逻辑执行不同战斗阶段等需求，只需要在 `Boss Scene` 中进行判断即可。
4. 符卡练习等功能可以靠单独定义 `Boss Scene` 来实现，提供更多的自定义空间。

## 注意事项

1. 对话系统的逻辑将会从 boss 系统中剥离，需要单独实现，因为它和 boss 的逻辑并不相关，它应当是一个单独的可以直接被调用的系统。
2. UI 信息部件由部件自主获取数据变更为需要被动更新，独立使用时需要注意参数更新调用
3. 对于符卡练习可能会增加许多额外的手动定义逻辑，需要提供一些工具来简化这个过程。
4. 由于 boss 场景系统的逻辑会变得更加复杂，可能会导致一些难以调试的问题，逻辑的复杂度也可能会导致一些性能问题。